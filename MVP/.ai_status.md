# Project: CARGO - AI Status Log
> Source of Truth for Project Architecture and Progress.

### [2026-01-31 10:00] Initialization (Project Start)
- **Goal**: Initialize the MVP for Project: CARGO, focusing on Level 1 (Power Box).
- **Changes**: 
  - Created `MVP` directory.
  - Initialized `.ai_status.md`.
- **Reasoning**: Establishing the project foundation and tracking mechanism as per "AI Collaborative Coding Guidelines".
- **Next**: Implement core modules (`prompts.py`, `game_state.py`, `main.py`).

### [2026-01-31 10:15] Core Engine Implementation (MVP Level 1)
- **Goal**: Implement the complete interaction loop for Level 1 (Power Box).
- **Changes**:
  - Implemented `prompts.py`: Defined Jack's "Blue collar/Panic" persona and context injection.
  - Implemented `game_state.py`: Created State Machine for the Power Box (Start -> Open -> Red -> Blue -> Power On).
  - Implemented `scenario_manager.py`: Added Regex-based intent parser to map user commands to game states.
  - Implemented `survivor_jack.py`: Created LLM wrapper with a Mock Mode for testing without API keys.
  - Implemented `main.py`: Built the main game loop.
  - Added `demo_run.py`: Script to automate the demo sequence.
- **Reasoning**: To verify the "Non-GUI / Text-Only" constraint and ensure the State Machine logic works as described in the whitepaper (inferred).
- **Next**: Connect to real LLM API; Implement Level 2; Add more complex wiring logic.

### [2026-01-31 10:30] LLM Integration (hiapi.online)
- **Goal**: Connect the game engine to the live LLM API provided by the user.
- **Changes**:
  - Updated `MVP/api_key.txt` with `hiapi.online` credentials.
  - Updated `MVP/survivor_jack.py` to use `openai` client with custom Base URL.
  - Enabled Live Mode (`use_mock=False`) in `MVP/main.py`.
- **Reasoning**: To enable dynamic, non-deterministic roleplay responses from Jack.
- **Next**: Refine prompt engineering to reduce hallucinations (Jack sometimes claims he already did things); Add more robust error handling for API timeouts.

### [2026-01-31 10:45] LLM Upgrade: Gemini 3 Pro Preview
- **Goal**: Upgrade the LLM to Google's bleeding-edge `gemini-3-pro-preview` model.
- **Changes**:
  - Detected and utilized the native Google API Key (`AIza...`) from the environment.
  - Refactored `MVP/survivor_jack.py` to support dual providers (`openai` and `google.generativeai`).
  - Switched the active model to `gemini-3-pro-preview` after diagnosing availability with `list_models.py`.
- **Reasoning**: User explicitly requested "Gemini 3 Pro". The diagnostic script confirmed `models/gemini-3-pro-preview` is available in this environment.
- **Next**: Monitor token usage and latency with the new preview model.

### [2026-01-31 11:00] Verification of Dynamic LLM Generation
- **Goal**: Prove that responses are dynamically generated by Gemini and not hardcoded.
- **Changes**:
  - Updated `MVP/survivor_jack.py` to add `[DEBUG]` logs confirming the provider call.
  - Implemented Strict Mode: The system now raises an error instead of falling back to Mock if the API fails.
  - Created `MVP/verify_llm.py` to run a creative prompt ("Sing a song") which succeeded.
- **Reasoning**: To ensure "no preset answers" as requested by the user.
- **Next**: Proceed with Level 2 development or UI enhancements.

### [2026-01-31 11:15] Mission Protocol & API Management Spec
- **Goal**: Establish the comprehensive Design Bible and Engineering Specifications as per "KIMI_CLUSTER_MISSION_PROTOCOL".
- **Changes**:
  - Created `demo` directory.
  - Created `demo/KIMI_CLUSTER_MISSION_PROTOCOL.md`: Detailed the "The Martian"-style game design, including persona (Jack), opening script, "MacGyver" puzzle mechanics, and technical architecture (JSON Schema, AI Middleware, Physics Engine).
  - Created `demo/API_MANAGEMENT.md`: Defined security protocols for Gemini 3 Pro API keys (Env vars > Local file) and rotation strategy.
- **Reasoning**: To provide a solid blueprint for "Project: CARGO" before proceeding to full-scale coding, ensuring the "Design First, Code Later" constraint is met.
- **Next**: Begin implementing the Frontend Manual Engine based on the new JSON Schema.

### [2026-01-31 11:30] Frontend Manual Engine Implementation (Phase 2.1)
- **Goal**: Implement the interactive Technical Manual interface with structured data (Specs, Warnings, Lore).
- **Changes**:
  - Created `frontend/src/types/manual.ts`: Defined `ManualEntry` schema supporting technical specs and lore snippets.
  - Created `frontend/src/data/manualData.ts`: Populated with "RTG-MK1" (from protocol) and "CO2-SCRUB-MK4" data.
  - Refactored `frontend/src/components/ManualMonitor.tsx`: Implemented a split-pane CRT interface with tabbed technical content, warning highlights, and physics formula display. Preserved original SVG for legacy support.
- **Reasoning**: To realize the "Manual Engine" spec from the Design Bible, providing the player with the "boring but necessary" technical context needed to guide Jack.
- **Next**: Implement Phase 2.2: The AI Interpreter Logic (Middleware) to handle dangerous instructions.

### [2026-01-31 11:45] AI Interpreter Logic Implementation (Phase 2.2)
- **Goal**: Implement the AI Middleware to intercept and analyze dangerous user commands before they reach Jack.
- **Changes**:
  - Installed `google-generativeai` package to enable Gemini API access in Python 3.9 environment.
  - Created `MVP/ai_middleware.py`: Implemented `CommandInterpreter` class with JSON-based intent analysis and safety rule validation (e.g., High Temp, Radiation).
  - Updated `MVP/main.py`: Integrated the middleware into the main game loop. Dangerous commands now trigger a "SYSTEM INTERCEPT" and a sarcastic warning from Jack, blocking the action.
  - Created `MVP/verify_safety.py`: Verified the logic with test cases ("Lick wire" -> Blocked, "Open box" -> Allowed).
- **Reasoning**: To prevent "Game Over" scenarios from being trivialized and to enforce the "Hard Sci-Fi Logic" constraint where physics (and stupidity) kills.
- **Next**: Implement Phase 2.3: Backend Physics Simulation (State Machine for O2/Temp).

### [2026-01-31 12:00] Backend Physics Simulation (Phase 2.3)
- **Goal**: Implement the Hard Sci-Fi Physics Engine to simulate habitat environmental changes (CO2, Temp, Pressure).
- **Changes**:
  - Created `MVP/physics_engine.py`: Implemented `PhysicsEngine` class with `EnvironmentState` (O2, CO2, Temp, Pressure) and `JackState` (Stress, HR).
  - Implemented dynamic simulation rules:
    - CO2 rises if `SCRUBBER` is OFF.
    - Temperature drops if `HEATER` is OFF (Newton's Law of Cooling).
    - Pressure drops if `SEALS` are breached.
  - Updated `MVP/main.py`: Integrated the Physics Engine into the main loop. Every turn advances time by 1 minute.
  - Added HUD Telemetry: The console now displays `[HUD] CO2: 0.045% | TEMP: 19.9Â°C` before every prompt.
  - Updated AI Middleware Context: Real-time telemetry is now passed to the AI safety analyzer so it knows the context (e.g., "Take off helmet" is unsafe if Pressure < 60kPa).
- **Reasoning**: To create the "ticking clock" tension typical of *The Martian*. Jack isn't just standing in a room; he is slowly freezing and suffocating unless the player acts.
- **Next**: Phase 2.4: Define WebSocket API for Frontend-Backend communication (or mock it for MVP).

### [2026-01-31 12:15] WebSocket Server Implementation (Phase 2.4)
- **Goal**: Expose the Game Engine via a real-time WebSocket API (FastAPI) to allow frontend integration.
- **Changes**:
  - Installed `fastapi` and `uvicorn`.
  - Refactored `MVP/main.py`: Extracted `process_turn()` method from the loop to allow external invocation.
  - Created `MVP/server.py`: Implemented a FastAPI WebSocket endpoint (`/ws`) that:
    - Maintains a persistent connection.
    - Sends initial game state and telemetry on connect.
    - Receives JSON commands, processes turns via `process_turn()`, and returns JSON responses.
- **Reasoning**: To move from a CLI-based MVP to a true Client-Server architecture as specified in the "Engineering Spec". This enables the React frontend (Phase 3) to actually control the Python backend.
- **Next**: Launch the server and update the frontend to connect to `ws://localhost:8000/ws`.

### [2026-01-31 12:30] Frontend Integration (Phase 3)
- **Goal**: Connect the React Frontend to the FastAPI Backend via WebSocket to enable real-time gameplay.
- **Changes**:
  - Refactored `frontend/src/hooks/useGameController.ts`: Replaced mock logic with a real `WebSocket` client connecting to `ws://localhost:8000/ws`. Handles `INIT`, `UPDATE`, `WIN`, `GAME_OVER`, `INTERCEPT` message types.
  - Updated `frontend/src/components/AdvisorMonitor.tsx`: Replaced static placeholders with a dynamic Telemetry Dashboard visualizing `CO2`, `TEMP`, and `HEART_RATE` from the backend physics engine.
  - Updated `frontend/src/App.tsx`: Wired the new `telemetry` data flow into the UI components.
- **Reasoning**: Completing the loop. Now the browser interface directly controls the Python game engine, with real-time feedback from the physics simulation and AI middleware.
- **Next**: Launch the backend server (`uvicorn MVP.server:app`) and verify the end-to-end flow.

### [2026-01-31 12:45] System Launch (Go Live)
- **Goal**: Start the backend services and finalize the deployment.
- **Changes**:
  - Executed `uvicorn MVP.server:app --reload` on port 8000.
  - Verified server startup logs indicating successful initialization of `gemini-3-pro-preview` model.
  - Verified Frontend is running on port 5174.
- **Reasoning**: The system is now fully operational. "Project: CARGO" MVP is live.
- **Next**: User testing and gameplay iteration.

### [2026-01-31 13:00] Phase 1 Complete: Hard Sci-Fi Physics Engine V1.0
- **Goal**: Upgrade the core simulation engine to match the "Project: CARGO" Engineering Spec (V1.0).
- **Changes**:
  - Created `MVP/state_schema.py`: Defined full Pydantic models for `GameState` (Env, Power, LifeSupport, Jack).
  - Rewrote `MVP/physics_engine.py`: Implemented `PhysicsSimulator` with Gas Laws ($PV=nRT$), Newton's Law of Cooling, and Power Grid simulation.
  - Refactored `MVP/main.py`: Converted to a Real-Time Engine with a `tick()` method.
  - Updated `MVP/server.py`: Added `asyncio` background task to run physics at 1Hz and broadcast telemetry.
  - Updated `frontend/src/hooks/useGameController.ts`: Added support for `TICK` messages.
- **Reasoning**: To transition from a static text game to a dynamic survival simulation where the environment (CO2, Temp) changes in real-time, creating urgency.
- **Next**: Phase 2: Upgrade Jack's Persona & AI Middleware (Safety Checks).

### [2026-01-31 13:15] Phase 2 Complete: "The Brain" (Persona & Middleware)
- **Goal**: Upgrade Jack's AI Persona and implement Safety Protocols.
- **Changes**:
  - Updated `MVP/prompts.py`: Injected V1.0 System Prompt with "Blue-collar" persona, Knowledge Boundaries, and Stress System.
  - Updated `MVP/ai_middleware.py`: Implemented 3-Layer Safety Check:
    1.  **Keyword Check**: Blocks immediate death commands (e.g., "remove helmet", "suicide").
    2.  **Semantic Parse**: Uses LLM to extract structured intent (`action`, `target`).
    3.  **Context Check**: Validates actions against physics (e.g., preventing airlock opening if pressure diff is high).
- **Reasoning**: To ensure the AI behaves like a scared survivor, not a generic assistant, and to prevent the game from ending instantly due to player trolling.
- **Next**: Phase 3: Gameplay Scenarios (MacGyver Moments).
